<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevOps Mission Control: 2065 Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js for 3D Background -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <style>
        /* Define the futuristic font and the dark, space background */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0f1a; /* Deep Space Navy */
            color: #e0f7fa; /* Light Aqua */
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* 3D Canvas Styling */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -10; /* Ensure it's behind everything */
            opacity: 0.8;
        }

        /* Glass/Acrylic Effect for containers */
        .fui-glass {
            background-color: rgba(16, 18, 27, 0.7); /* Dark transparent */
            border: 1px solid rgba(0, 255, 255, 0.2); /* Neon cyan border */
            backdrop-filter: blur(8px);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.1), inset 0 0 5px rgba(0, 255, 255, 0.05); /* Subtle inner/outer glow */
        }
        
        /* Neon Focus Rings */
        input:focus, textarea:focus, select:focus {
            border-color: #00ffff !important; /* Neon cyan */
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.6) !important;
            outline: none;
        }

        /* Custom scrollbar for FUI look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #00ffff; /* Neon cyan */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #00d0d0;
        }
        ::-webkit-scrollbar-track {
            background: rgba(16, 18, 27, 0.7);
        }
        
        /* Neon button hover effects */
        .fui-btn-neon:hover {
            box-shadow: 0 0 10px rgba(4, 116, 116, 0.8), 0 0 5px rgba(0, 255, 255, 0.4);
        }
        /* Custom checkbox style */
        .fui-checkbox {
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid #00ffff;
            background-color: transparent;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }
        .fui-checkbox:checked {
            background-color: #00ffff;
            border-color: #00ffff;
        }
        .fui-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            color: #0d0f1a;
            font-weight: bold;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- 3D Background Canvas -->
    <canvas id="bg-canvas"></canvas>

    <!-- Notification Area (Used instead of alert()) -->
    <div id="notification" class="fixed top-4 right-4 p-4 rounded-xl shadow-xl font-semibold transition-transform duration-300 z-50 transform translate-x-full text-black"></div>

    <header class="fui-glass p-4 sticky top-0 z-10 border-b-2 border-cyan-500/50">
        <div class="container-fluid mx-auto flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0">
            <h1 class="text-3xl font-extrabold text-white">
                <span class="text-[#00ffff]">DEVOPS</span> MISSION CONTROL
            </h1>
            <div class="text-sm font-mono text-cyan-300/70">
                // System Status: Local Memory Sync Active (LMS)
            </div>
        </div>
    </header>

    <main class="container-fluid mx-auto p-4 md:p-8 relative z-0">
        
        <!-- Metrics Dashboard -->
        <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Metric Card 1: Total Tasks -->
            <div class="fui-glass p-6 rounded-xl border-l-4 border-[#00ffff]">
                <p class="text-sm font-mono text-cyan-300/70">Total Tasks Filed</p>
                <p id="metric-total-tasks" class="text-3xl font-extrabold text-[#00ffff] mt-1">0</p>
            </div>
            <!-- Metric Card 2: Completed Tasks -->
            <div class="fui-glass p-6 rounded-xl border-l-4 border-[#22c55e]">
                <p class="text-sm font-mono text-green-300/70">Tasks Completed</p>
                <p id="metric-completed-tasks" class="text-3xl font-extrabold text-[#22c55e] mt-1">0</p>
            </div>
            <!-- Metric Card 3: Total Estimated Time -->
            <div class="fui-glass p-6 rounded-xl border-l-4 border-[#eab308]">
                <p class="text-sm font-mono text-yellow-300/70">Total Est. Workload (Hours)</p>
                <p id="metric-total-time" class="text-3xl font-extrabold text-[#eab308] mt-1">0.0h</p>
            </div>
        </section>

        <!-- Form and File Operations -->
        <section class="fui-glass p-6 rounded-xl mb-8">
            <h2 class="text-2xl font-bold text-white mb-4" id="form-title">Define New Task Specification</h2>
            <form id="task-form">
                <input type="hidden" id="editing-task-id" name="id" value="">

                <!-- Task Name (Full Width) -->
                <input type="text" name="name" id="task-name-input" placeholder="Task Name (e.g., Implement Feature X, Refactor Class Y)" required 
                        class="w-full p-3 border border-cyan-500/30 rounded-lg bg-black/50 text-white transition-colors mb-4">
                
                <!-- Subtask Management Area - NEW -->
                <div class="fui-glass p-4 rounded-lg mb-4 border border-cyan-500/10">
                    <h3 class="text-lg font-semibold text-cyan-300 mb-3">// Subtask Payload Definition</h3>
                    <!-- Input for new subtask -->
                    <div class="flex space-x-2 mb-3">
                        <input type="text" id="subtask-input-field" placeholder="Define implementation step (e.g., Write SQL, Create API endpoint)..." 
                               class="flex-1 p-3 border border-cyan-500/30 rounded-lg bg-black/50 text-white transition-colors">
                        <button type="button" id="add-subtask-btn" 
                                class="bg-cyan-700 text-white text-sm font-bold rounded-lg shadow-md hover:bg-cyan-600 px-4 py-2 transition-all duration-300">
                            + Add Step
                        </button>
                    </div>
                    <!-- List of draft subtasks -->
                    <div id="subtask-draft-list" class="space-y-2 max-h-40 overflow-y-auto p-1">
                        <p id="subtask-placeholder" class="text-sm text-cyan-400/50 italic">No implementation steps defined yet.</p>
                        <!-- Draft subtasks will be rendered here by JS -->
                    </div>
                </div>


                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                    <!-- Priority Select -->
                    <select name="priority" class="p-3 border border-cyan-500/30 rounded-lg bg-black/50 text-white transition-colors">
                        <option class="bg-[#0d0f1a] text-red-400" value="High">Priority: HIGH</option>
                        <option class="bg-[#0d0f1a] text-yellow-400" value="Medium" selected>Priority: MEDIUM</option>
                        <option class="bg-[#0d0f1a] text-green-400" value="Low">Priority: LOW</option>
                    </select>
                    <!-- Estimated Hours Input -->
                    <input type="number" name="estimate" placeholder="Est. Hours (e.g., 4.0)" value="4.0" min="0.5" step="0.5" required 
                            class="p-3 border border-cyan-500/30 rounded-lg bg-black/50 text-white transition-colors">
                    
                    <!-- Action Buttons -->
                    <div id="form-actions" class="flex space-x-2 col-span-2 md:col-span-1">
                        <button type="submit" id="submit-btn" class="flex-1 bg-[#00ffff] text-gray-900 font-bold rounded-lg shadow-md hover:bg-[#00d0d0] fui-btn-neon transition-all duration-300">
                            File Task
                        </button>
                        <!-- Cancel Button (only visible during edit) -->
                        <button type="button" id="cancel-edit-btn" class="flex-1 bg-gray-700 text-white font-bold rounded-lg shadow-md hover:bg-gray-600 transition-colors duration-300 text-sm hidden">
                            Cancel
                        </button>
                    </div>

                    <div class="flex space-x-2 col-span-2 md:col-span-1">
                        <!-- File I/O Buttons -->
                        <button type="button" id="export-btn" class="flex-1 bg-gray-900 text-[#00ffff] font-bold rounded-lg shadow-md border border-[#00ffff]/50 hover:bg-gray-800 fui-btn-neon transition-all duration-300 text-sm p-3">
                            Export Backlog
                        </button>
                        <button type="button" id="import-btn" class="flex-1 bg-gray-900 text-[#00ffff] font-bold rounded-lg shadow-md border border-[#00ffff]/50 hover:bg-gray-800 fui-btn-neon transition-all duration-300 text-sm p-3">
                            Import Backlog
                        </button>
                        <input type="file" id="file-input" accept=".txt,.json" class="hidden">
                    </div>
                </div>
            </form>
        </section>

        <!-- Task List (The Flight Plan) -->
        <h2 class="text-2xl font-bold text-white mb-6 border-b border-cyan-500/50 pb-2">Active Task Queue</h2>
        <section id="task-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Task Cards will be rendered here by JavaScript -->
        </section>

    </main>

    <script>
        // --- THREE.JS 3D Background Logic ---
        
        let camera, scene, renderer, stars;
        let mouseX = 0, mouseY = 0;
        let windowHalfX = window.innerWidth / 2;
        let windowHalfY = window.innerHeight / 2;
        const PARTICLE_COUNT = 5000;

        function init3D() {
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.z = 5;

            scene = new THREE.Scene();
            
            const geometry = new THREE.BufferGeometry();
            const vertices = [];

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                vertices.push(
                    (Math.random() * 2000) - 1000,
                    (Math.random() * 2000) - 1000,
                    (Math.random() * 2000) - 1000
                );
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            
            const material = new THREE.PointsMaterial({ 
                color: 0x00ffff, 
                size: 1.5,
                blending: THREE.AdditiveBlending,
                transparent: true,
                opacity: 0.8
            });

            stars = new THREE.Points(geometry, material);
            scene.add(stars);

            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            document.addEventListener('mousemove', onDocumentMouseMove, false);
            window.addEventListener('resize', onWindowResize, false);
        }

        function onWindowResize() {
            windowHalfX = window.innerWidth / 2;
            windowHalfY = window.innerHeight / 2;

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onDocumentMouseMove(event) {
            mouseX = (event.clientX - windowHalfX);
            mouseY = (event.clientY - windowHalfY);
        }

        function animate3D() {
            requestAnimationFrame(animate3D);
            render3D();
        }

        function render3D() {
            const targetX = mouseX * 0.0001;
            const targetY = mouseY * 0.0001;

            camera.position.x += (targetX - camera.position.x) * 0.05;
            camera.position.y += (-targetY - camera.position.y) * 0.05;
            
            camera.lookAt(scene.position);

            stars.rotation.x += 0.0001;
            stars.rotation.y += 0.0002;

            renderer.render(scene, camera);
        }

        // --- Core Application Logic ---

        let tasks = []; // In-memory "database"
        let currentDraftSubtasks = []; // Subtasks being defined in the form

        // Task Constants - Updated to Software Terminology
        const TASK_STATUS = {
            PLANNED: 'PLANNED',
            IN_PROGRESS: 'IN PROGRESS',
            TESTING: 'TESTING',
            COMPLETED: 'COMPLETED',
        };

        const TASK_PRIORITY = {
            HIGH: 'High',
            MEDIUM: 'Medium',
            LOW: 'Low',
        };

        const STATUS_COLORS = {
            [TASK_STATUS.PLANNED]: 'bg-gray-700/50 text-gray-300 hover:bg-gray-600/70',
            [TASK_STATUS.IN_PROGRESS]: 'bg-blue-600/50 text-blue-300 hover:bg-blue-500/70',
            [TASK_STATUS.TESTING]: 'bg-yellow-600/50 text-yellow-300 hover:bg-yellow-500/70',
            [TASK_STATUS.COMPLETED]: 'bg-green-600/50 text-green-300 hover:bg-green-500/70',
        };

        const PRIORITY_COLORS = {
            [TASK_PRIORITY.HIGH]: 'border-red-500 text-red-400 shadow-red-500/50',
            [TASK_PRIORITY.MEDIUM]: 'border-yellow-500 text-yellow-400 shadow-yellow-500/50',
            [TASK_PRIORITY.LOW]: 'border-green-500 text-green-400 shadow-green-500/50',
        };

        // --- Utility Functions ---

        /**
         * Generates a unique ID for the main task.
         * @returns {string}
         */
        function generateMainTaskId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2, 5);
        }

        /**
         * Generates a unique ID for a subtask.
         * @returns {string}
         */
        function generateSubtaskId() {
             return 'sub-' + Math.random().toString(36).substring(2, 7);
        }
        
        /**
         * Displays a temporary notification banner.
         */
        function showNotification(message, bgColor) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            const finalBgColor = bgColor.includes('bg-') ? bgColor : 'bg-cyan-400';
            
            notif.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl font-semibold transition-transform duration-300 z-50 text-black ${finalBgColor} transform translate-x-0`;

            setTimeout(() => {
                notif.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl font-semibold transition-transform duration-300 z-50 text-black ${finalBgColor} transform translate-x-full`;
            }, 3000);
        }

        // --- File I/O for .txt 'Database' ---

        /**
         * Prompts the user to download the current tasks as a JSON-formatted .txt file.
         */
        function exportDataAsTextFile(action = 'Data saved') {
            const data = JSON.stringify(tasks, null, 2);
            const blob = new Blob([data], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `DevOps_Backlog_${new Date().toISOString().split('T')[0].replace(/-/g, '')}_${new Date().getHours()}${new Date().getMinutes()}${new Date().getSeconds()}.txt`;
            document.body.appendChild(a);
            
            // Use document.execCommand('copy') logic for a download, which works better in some sandbox environments
            a.click();
            
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification(`${action}. New Backlog manifest downloaded.`, 'bg-[#00ffff]');
        }

        /**
         * Imports tasks from a selected .txt file.
         */
        function importDataFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        tasks = importedData;
                        sortAndRenderTasks();
                        showNotification('Backlog Loaded. Ready for Deployment!', 'bg-green-400');
                        event.target.value = null;
                    } else {
                        throw new Error("Invalid file format. Expected a JSON array.");
                    }
                } catch (error) {
                    console.error("Error importing data:", error);
                    showNotification('ERROR: Backlog data corrupted or invalid.', 'bg-red-500');
                    event.target.value = null;
                }
            };
            reader.readAsText(file);
        }

        // --- Subtask Draft Management (For Form UI) ---

        /**
         * Renders the temporary list of subtasks currently in the form.
         */
        function renderDraftSubtasks() {
            const container = document.getElementById('subtask-draft-list');
            container.innerHTML = '';

            if (currentDraftSubtasks.length === 0) {
                container.innerHTML = `<p id="subtask-placeholder" class="text-sm text-cyan-400/50 italic">No implementation steps defined yet.</p>`;
                return;
            }

            currentDraftSubtasks.forEach(subtask => {
                const subtaskElement = document.createElement('div');
                subtaskElement.className = `flex items-center justify-between p-2 text-sm rounded-lg ${subtask.completed ? 'bg-green-800/20 text-green-300 line-through' : 'bg-white/5 text-white'}`;
                subtaskElement.innerHTML = `
                    <span class="flex-1 mr-2">${subtask.description}</span>
                    <div class="flex space-x-2 text-white/70">
                        <button type="button" data-id="${subtask.id}" class="edit-draft-btn hover:text-yellow-400 transition-colors" aria-label="Edit Subtask Draft">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        </button>
                        <button type="button" data-id="${subtask.id}" class="delete-draft-btn hover:text-red-500 transition-colors" aria-label="Delete Subtask Draft">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                `;
                container.appendChild(subtaskElement);
            });

            // Attach listeners for draft actions
            container.querySelectorAll('.edit-draft-btn').forEach(button => {
                button.addEventListener('click', (e) => editDraftSubtask(e.currentTarget.getAttribute('data-id')));
            });
            container.querySelectorAll('.delete-draft-btn').forEach(button => {
                button.addEventListener('click', (e) => deleteDraftSubtask(e.currentTarget.getAttribute('data-id')));
            });
        }

        /**
         * Adds a new subtask to the draft list from the input field.
         */
        function addSubtaskToDraft() {
            const inputField = document.getElementById('subtask-input-field');
            const description = inputField.value.trim();

            if (description) {
                const isEditingDraftId = inputField.getAttribute('data-editing-id');
                
                if (isEditingDraftId) {
                    // Update existing draft subtask
                    const subtaskIndex = currentDraftSubtasks.findIndex(s => s.id === isEditingDraftId);
                    if (subtaskIndex !== -1) {
                        currentDraftSubtasks[subtaskIndex].description = description;
                    }
                    inputField.removeAttribute('data-editing-id');
                    document.getElementById('add-subtask-btn').textContent = '+ Add Step';
                    document.getElementById('subtask-input-field').placeholder = 'Define implementation step...';
                    showNotification('Draft step updated.', 'bg-yellow-400');
                } else {
                    // Create new subtask
                    currentDraftSubtasks.push({
                        id: generateSubtaskId(),
                        description: description,
                        completed: false
                    });
                    showNotification('New step added to payload.', 'bg-cyan-400');
                }
                
                inputField.value = '';
                renderDraftSubtasks();
            } else {
                 showNotification('Subtask description cannot be empty.', 'bg-red-500');
            }
        }

        /**
         * Loads a draft subtask into the input field for editing.
         */
        function editDraftSubtask(subtaskId) {
            const subtask = currentDraftSubtasks.find(s => s.id === subtaskId);
            if (subtask) {
                const inputField = document.getElementById('subtask-input-field');
                inputField.value = subtask.description;
                inputField.setAttribute('data-editing-id', subtask.id);
                document.getElementById('add-subtask-btn').textContent = 'Update Step';
                document.getElementById('subtask-input-field').placeholder = 'Editing step...';
                inputField.focus();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        /**
         * Deletes a subtask from the draft list.
         */
        function deleteDraftSubtask(subtaskId) {
            currentDraftSubtasks = currentDraftSubtasks.filter(s => s.id !== subtaskId);
            renderDraftSubtasks();
            showNotification('Draft step removed.', 'bg-red-400');
        }

        // --- Subtask Operations (On Active Tasks) ---

        /**
         * Toggles the completion status of a subtask within a main task.
         */
        function toggleSubtaskCompletion(taskId, subtaskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const subtask = task.subtasks.find(s => s.id === subtaskId);
            if (subtask) {
                subtask.completed = !subtask.completed;
                sortAndRenderTasks();
                exportDataAsTextFile('Subtask Status Toggled');
            }
        }

        /**
         * Deletes a subtask from an active main task.
         */
        function deleteSubtask(taskId, subtaskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.subtasks = task.subtasks.filter(s => s.id !== subtaskId);
                sortAndRenderTasks();
                exportDataAsTextFile('Subtask Removed from Active Task');
            }
        }
        
        /**
         * Opens a prompt to edit an active subtask's description.
         * NOTE: Using a simple JS prompt as a placeholder for a complex custom modal UI.
         */
        function editActiveSubtask(taskId, subtaskId, currentDescription) {
            const task = tasks.find(t => t.id === taskId);
            const subtask = task?.subtasks.find(s => s.id === subtaskId);
            if (!subtask) return;

            const newDescription = prompt(`Enter new description for subtask (${subtaskId.substring(4)}):`, currentDescription);
            
            if (newDescription !== null && newDescription.trim() !== '') {
                subtask.description = newDescription.trim();
                sortAndRenderTasks();
                exportDataAsTextFile('Subtask Description Updated');
            } else if (newDescription !== null) {
                showNotification('Edit cancelled or description was empty.', 'bg-gray-700');
            }
        }

        // --- CRUD Operations (In-Memory) ---
        
        /**
         * Creates a new task.
         */
        function createTask(taskData) {
            const task = {
                id: generateMainTaskId(),
                ...taskData,
                subtasks: currentDraftSubtasks, // Use the current draft
                status: TASK_STATUS.PLANNED,
                createdAt: new Date().toISOString()
            };
            tasks.push(task);
            showNotification('New Task Filed.', 'bg-cyan-400');
            exportDataAsTextFile('New Task Filed');
        }

        /**
         * Updates an existing task's core details.
         */
        function updateTask(taskId, updatedData) {
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                tasks[taskIndex] = {
                    ...tasks[taskIndex],
                    ...updatedData,
                    subtasks: currentDraftSubtasks // Update subtasks from draft
                };
                showNotification(`Task ${taskId.substring(0, 8)} Updated.`, 'bg-yellow-400');
                exportDataAsTextFile('Task Specification Updated');
            }
        }

        /**
         * Handles the submission of the form (either Create or Update).
         */
        function handleTaskSubmit(taskData, taskId) {
            if (taskId) {
                updateTask(taskId, taskData);
            } else {
                createTask(taskData);
            }
            // Clear the subtask draft list after successful submission
            currentDraftSubtasks = []; 
            clearEditForm();
            sortAndRenderTasks();
        }

        /**
         * Cycles the status of a task.
         */
        function updateTaskStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const statuses = Object.values(TASK_STATUS);
            const currentIndex = statuses.indexOf(task.status);
            task.status = statuses[(currentIndex + 1) % statuses.length];
            
            sortAndRenderTasks();
            showNotification(`Task status cycled to: ${task.status}`, 'bg-cyan-400');
            exportDataAsTextFile('Task Status Changed');
        }

        /**
         * Deletes a task by ID.
         */
        function deleteTask(taskId) {
            const initialLength = tasks.length;
            tasks = tasks.filter(t => t.id !== taskId);
            
            if (tasks.length < initialLength) {
                sortAndRenderTasks();
                showNotification(`Task ${taskId.substring(0, 8)} Decommissioned.`, 'bg-red-400');
                exportDataAsTextFile('Task Decommissioned');
            }
        }

        // --- UI Rendering and Metrics ---

        /**
         * Sorts tasks and triggers re-rendering.
         */
        function sortAndRenderTasks() {
            tasks.sort((a, b) => {
                const priorityOrder = { [TASK_PRIORITY.HIGH]: 3, [TASK_PRIORITY.MEDIUM]: 2, [TASK_PRIORITY.LOW]: 1 };
                const statusOrder = { [TASK_STATUS.PLANNED]: 4, [TASK_STATUS.IN_PROGRESS]: 3, [TASK_STATUS.TESTING]: 2, [TASK_STATUS.COMPLETED]: 1 };

                if (priorityOrder[b.priority] !== priorityOrder[a.priority]) {
                    return priorityOrder[b.priority] - priorityOrder[a.priority];
                }
                return statusOrder[b.status] - statusOrder[a.status];
            });

            renderTasks();
            updateMetrics();
        }
        
        /**
         * Clears the form and resets it from the editing state back to creation state.
         */
        function clearEditForm() {
            document.getElementById('task-form').reset();
            document.getElementById('editing-task-id').value = '';
            document.getElementById('submit-btn').textContent = 'File Task';
            document.getElementById('submit-btn').classList.remove('bg-yellow-600', 'hover:bg-yellow-500', 'text-gray-900');
            document.getElementById('submit-btn').classList.add('bg-[#00ffff]', 'hover:bg-[#00d0d0]');
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            document.getElementById('form-title').textContent = 'Define New Task Specification';
            document.querySelector('input[name="estimate"]').value = 4.0;

            // Reset subtask draft state
            currentDraftSubtasks = [];
            document.getElementById('subtask-input-field').value = '';
            document.getElementById('subtask-input-field').removeAttribute('data-editing-id');
            document.getElementById('add-subtask-btn').textContent = '+ Add Step';
            document.getElementById('subtask-input-field').placeholder = 'Define implementation step...';
            renderDraftSubtasks(); // Re-render the empty draft list
        }

        /**
         * Fills the form with existing task data for editing.
         */
        function fillEditForm(task) {
            document.getElementById('editing-task-id').value = task.id;
            document.querySelector('input[name="name"]').value = task.name;
            document.querySelector('select[name="priority"]').value = task.priority;
            document.querySelector('input[name="estimate"]').value = task.estimate;

            // Load existing subtasks into the draft state for editing
            currentDraftSubtasks = JSON.parse(JSON.stringify(task.subtasks || [])); // Deep copy
            renderDraftSubtasks();

            document.getElementById('submit-btn').textContent = 'Update Task';
            document.getElementById('submit-btn').classList.remove('bg-[#00ffff]', 'hover:bg-[#00d0d0]');
            document.getElementById('submit-btn').classList.add('bg-yellow-600', 'hover:bg-yellow-500', 'text-gray-900');
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            document.getElementById('form-title').textContent = `Editing Task: ${task.name}`;

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        /**
         * Renders the list of subtasks for an individual task card.
         */
        function renderSubtasksList(taskId, subtasks) {
            if (!subtasks || subtasks.length === 0) {
                return '<p class="text-xs text-gray-400/70 italic p-2">// No payload steps defined.</p>';
            }

            const listItems = subtasks.map(subtask => {
                const checkedClass = subtask.completed ? 'line-through text-gray-400' : 'text-cyan-200';
                return `
                    <div class="flex items-start justify-between p-2 hover:bg-black/20 rounded-lg transition-colors">
                        <label class="flex items-start cursor-pointer flex-1">
                            <input type="checkbox" data-task-id="${taskId}" data-subtask-id="${subtask.id}" ${subtask.completed ? 'checked' : ''} class="fui-checkbox mt-1 toggle-subtask-btn">
                            <span class="ml-3 text-sm ${checkedClass} flex-1">${subtask.description}</span>
                        </label>
                        <div class="flex space-x-2 ml-4">
                            <button type="button" data-task-id="${taskId}" data-subtask-id="${subtask.id}" data-description="${subtask.description}" class="edit-active-subtask-btn text-yellow-400/80 hover:text-yellow-300 transition-colors" aria-label="Edit Subtask">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5l-2.917 2.917L19.5 11.917l2.917-2.917z"/><path d="M17.5 5.5l-1.5-1.5"/><path d="M3 10l6 6 4-4"/><path d="M3 14l2 2"/></svg>
                            </button>
                            <button type="button" data-task-id="${taskId}" data-subtask-id="${subtask.id}" class="delete-subtask-btn text-red-500/80 hover:text-red-400 transition-colors" aria-label="Delete Subtask">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 6V4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v2"/></svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            return `<div class="mt-3 space-y-1">${listItems}</div>`;
        }

        /**
         * Renders all tasks to the DOM.
         */
        function renderTasks() {
            const container = document.getElementById('task-list-container');
            container.innerHTML = '';

            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-10 fui-glass rounded-xl shadow-lg text-cyan-400/70 font-mono col-span-full">
                        // Backlog Empty. Deploy a new Task Specification.
                    </div>
                `;
            } else {
                tasks.forEach(task => {
                    const priorityClass = PRIORITY_COLORS[task.priority];
                    const statusClass = STATUS_COLORS[task.status];
                    
                    const subtaskCount = task.subtasks ? task.subtasks.length : 0;
                    const completedSubtasks = task.subtasks ? task.subtasks.filter(s => s.completed).length : 0;
                    const subtaskProgress = subtaskCount > 0 ? Math.round((completedSubtasks / subtaskCount) * 100) : 0;

                    const card = document.createElement('div');
                    card.className = `fui-glass p-5 rounded-xl border-l-8 ${priorityClass} shadow-xl relative transition-all duration-300 hover:scale-[1.02]`;
                    card.innerHTML = `
                        <!-- Header -->
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-xl font-bold text-white mb-1">${task.name}</h3>
                                <p class="text-xs font-mono ${priorityClass.split(' ')[1]}">P: ${task.priority} // ID: ${task.id.substring(0, 8)}</p>
                            </div>
                            <button data-id="${task.id}" class="update-status-btn text-sm font-semibold rounded-full px-3 py-1 transition-colors ${statusClass}">
                                ${task.status}
                            </button>
                        </div>

                        <!-- Progress and Estimate -->
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-sm font-semibold text-cyan-300">
                                <span>Subtask Progress:</span>
                                <span>${subtaskProgress}% (${completedSubtasks}/${subtaskCount})</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div class="h-2 rounded-full transition-all duration-500" style="width: ${subtaskProgress}%; background-color: ${subtaskProgress === 100 ? '#22c55e' : '#00ffff'};"></div>
                            </div>
                            <p class="text-sm font-mono text-yellow-400/70 mt-2">Est. Dev Time: ${task.estimate} hours</p>
                        </div>

                        <!-- Subtask Payload (Collapsible) -->
                        <details class="text-sm border-t border-cyan-500/20 pt-3">
                            <summary class="font-semibold text-cyan-300 cursor-pointer hover:text-[#00ffff] transition-colors">
                                Implementation Steps (${subtaskCount})
                            </summary>
                            <div class="bg-black/30 rounded-lg mt-2 max-h-48 overflow-y-auto">
                                ${renderSubtasksList(task.id, task.subtasks)}
                            </div>
                        </details>

                        <!-- Actions -->
                        <div class="flex justify-end space-x-2 mt-4 border-t border-cyan-500/20 pt-3">
                            <button data-id="${task.id}" class="edit-task-btn bg-blue-700 text-white p-2 rounded-full hover:bg-blue-600 transition-colors" aria-label="Edit Task">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button data-id="${task.id}" class="delete-task-btn bg-red-700 text-white p-2 rounded-full hover:bg-red-600 transition-colors" aria-label="Delete Task">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    `;
                    container.appendChild(card);
                });

                // Attach Task Actions
                container.querySelectorAll('.update-status-btn').forEach(button => {
                    button.addEventListener('click', (e) => updateTaskStatus(e.currentTarget.getAttribute('data-id')));
                });
                container.querySelectorAll('.edit-task-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const taskId = e.currentTarget.getAttribute('data-id');
                        const task = tasks.find(t => t.id === taskId);
                        if (task) fillEditForm(task);
                    });
                });
                container.querySelectorAll('.delete-task-btn').forEach(button => {
                    button.addEventListener('click', (e) => deleteTask(e.currentTarget.getAttribute('data-id')));
                });
                
                // Attach Subtask Actions
                container.querySelectorAll('.toggle-subtask-btn').forEach(input => {
                    input.addEventListener('change', (e) => {
                        toggleSubtaskCompletion(
                            e.currentTarget.getAttribute('data-task-id'),
                            e.currentTarget.getAttribute('data-subtask-id')
                        );
                    });
                });
                container.querySelectorAll('.delete-subtask-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                         deleteSubtask(
                            e.currentTarget.getAttribute('data-task-id'),
                            e.currentTarget.getAttribute('data-subtask-id')
                        );
                    });
                });
                 container.querySelectorAll('.edit-active-subtask-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        editActiveSubtask(
                            e.currentTarget.getAttribute('data-task-id'),
                            e.currentTarget.getAttribute('data-subtask-id'),
                            e.currentTarget.getAttribute('data-description')
                        );
                    });
                });
            }
        }


        /**
         * Calculates and updates the metrics dashboard.
         */
        function updateMetrics() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.status === TASK_STATUS.COMPLETED).length;
            const totalTime = tasks.reduce((sum, t) => sum + (t.estimate || 0), 0);

            document.getElementById('metric-total-tasks').textContent = totalTasks;
            document.getElementById('metric-completed-tasks').textContent = completedTasks;
            document.getElementById('metric-total-time').textContent = `${totalTime.toFixed(1)}h`;
        }
        
        /**
         * Loads initial mock data or persisted data on startup.
         */
        function loadInitialData() {
            // Since there is no localStorage for persistence here, we use mock data.
            tasks = [
               
            ];
            sortAndRenderTasks();
        }

        /**
         * Main initialization function run when the window loads.
         */
        window.onload = function() {
            try {
                // 1. Initialize 3D Background
                init3D();
                animate3D();
            } catch (e) {
                console.warn('Three.js initialization failed:', e);
                document.getElementById('bg-canvas').style.display = 'none'; // Hide canvas if 3D fails
            }

            // 2. Load Initial Data
            loadInitialData();
            
            // 3. Setup Form Submission Listener
            document.getElementById('task-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                
                // Validate if any subtasks were created if it's a new task
                const taskId = document.getElementById('editing-task-id').value;
                if (currentDraftSubtasks.length === 0 && !taskId) {
                     showNotification('Task requires at least one implementation step.', 'bg-red-500');
                     return;
                }

                const taskData = {
                    name: form.elements.name.value.trim(),
                    priority: form.elements.priority.value,
                    estimate: parseFloat(form.elements.estimate.value),
                };

                if (!taskData.name) {
                    showNotification('Task name is required.', 'bg-red-500');
                    return;
                }

                handleTaskSubmit(taskData, taskId);
            });
            
            // 4. Setup Form/Edit UI listeners
            document.getElementById('cancel-edit-btn').addEventListener('click', clearEditForm);
            document.getElementById('add-subtask-btn').addEventListener('click', addSubtaskToDraft);
            
            // 5. Setup File I/O listeners
            document.getElementById('export-btn').addEventListener('click', () => exportDataAsTextFile('Backlog Exported'));
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('file-input').click());
            document.getElementById('file-input').addEventListener('change', importDataFromFile);
            
            // Initial render of empty draft list
            renderDraftSubtasks();
        };

    </script>
</body>
</html>
